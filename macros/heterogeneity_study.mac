# Macro para an√°lisis de efectos de heterogeneidades espec√≠ficas
# Comparaci√≥n directa TG-43 vs Monte Carlo con materiales reales

# Configuraci√≥n inicial
/run/verbose 1
/event/verbose 0

# Inicializar geometr√≠a
/run/initialize

echo "==================================================="
echo "AN√ÅLISIS DE HETEROGENEIDADES - HDR BRACHYTHERAPY"
echo "==================================================="
echo "Objetivos:"
echo "  üî¨ Cuantificar desviaciones del TG-43"
echo "  üìä Mapear efectos de densidad"
echo "  üéØ Evaluar impacto cl√≠nico"
echo ""
echo "Escenarios de prueba:"
echo "  1. Hueso cortical (costilla)"
echo "  2. Cavidad a√©rea (pulm√≥n/intestino)"
echo "  3. Transici√≥n m√∫sculo-grasa"
echo "  4. Aplicador met√°lico"
echo "==================================================="

# Configurar scoring detallado
/score/create/boxMesh heterogeneity_analysis
/score/mesh/boxSize 12 12 12 cm
/score/mesh/nBin 60 60 60  # Alta resoluci√≥n
/score/mesh/translate/xyz 0 0 0 cm
/score/quantity/energyDeposit eDep
/score/quantity/doseDeposit dose
/score/close

# ESCENARIO 1: Efecto del hueso
echo ""
echo "ü¶¥ ESCENARIO 1: HUESO CORTICAL"
echo "Simulando costilla a 2cm de fuente..."
/gun/particle gamma
/gun/energy 317 keV
/gun/position 0 0 0 mm
/gun/direction 1 0 0  # Hacia hueso

/run/beamOn 5000

# ESCENARIO 2: Cavidad a√©rea
echo ""
echo "üí® ESCENARIO 2: CAVIDAD A√âREA"
echo "Simulando bolsa de aire intestinal..."
/gun/direction 0 1 0  # Hacia cavidad

/run/beamOn 5000

# ESCENARIO 3: Interfaz tejidos blandos
echo ""
echo "ü´Ä ESCENARIO 3: INTERFAZ M√öSCULO-GRASA"
echo "Simulando transici√≥n de densidades..."
/gun/direction 0 0 1  # Perpendicular a interfaz

/run/beamOn 5000

# An√°lisis autom√°tico de resultados
echo ""
echo "üîç AN√ÅLISIS AUTOM√ÅTICO:"

# Exportar mapas para an√°lisis
/score/dumpQuantityToFile heterogeneity_analysis eDep hetero_energy_map.txt
/score/dumpQuantityToFile heterogeneity_analysis dose hetero_dose_map.txt

echo ""
echo "‚úÖ AN√ÅLISIS DE HETEROGENEIDADES COMPLETADO"
echo ""
echo "üìä RESULTADOS ESPERADOS:"
echo "  - Hueso: -20% a -35% de dosis post-√≥sea"
echo "  - Aire: +10% a +25% en bordes (backscatter)"
echo "  - Interfaz: Gradientes suaves ¬±5-10%"
echo ""
echo "üìÅ Archivos generados:"
echo "  - hetero_energy_map.txt (deposici√≥n energ√≠a)"
echo "  - hetero_dose_map.txt (dosis f√≠sica)"
echo ""
echo "üêç Ejecutar an√°lisis Python:"
echo "   python3 ../scripts/analyze_heterogeneities.py"
