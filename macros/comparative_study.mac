# Macro para comparaci√≥n TG-43 vs Heterogeneous vs Clinical
# Ejecuta las 3 geometr√≠as en secuencia para an√°lisis comparativo

# Configuraci√≥n global
/run/verbose 1
/event/verbose 0

echo "============================================================="
echo "ESTUDIO COMPARATIVO COMPLETO - HDR BRACHYTHERAPY"
echo "============================================================="
echo "An√°lisis: Monte Carlo vs TG-43 Protocol"
echo ""
echo "Escenarios a simular:"
echo "  1Ô∏è‚É£  TG-43 Standard (agua pura) - BASELINE"
echo "  2Ô∏è‚É£  Heterogeneous phantom - REALISTIC"
echo "  3Ô∏è‚É£  Clinical scenario - PATIENT-SPECIFIC"
echo ""
echo "Objetivo: Cuantificar desviaciones del protocolo TG-43"
echo "============================================================="

# Inicializar geometr√≠a
/run/initialize

# Configurar scoring com√∫n para comparaci√≥n
/score/create/boxMesh comparison_mesh
/score/mesh/boxSize 15 15 15 cm
/score/mesh/nBin 50 50 50
/score/mesh/translate/xyz 0 0 0 cm
/score/quantity/energyDeposit eDep
/score/quantity/doseDeposit dose
/score/close

# Configurar fuente est√°ndar
/gun/particle gamma
/gun/energy 317 keV  # L√≠nea principal Ir-192
/gun/position 0 0 0 mm

# ============================================================
# ESCENARIO 1: TG-43 BASELINE (AGUA PURA)
# ============================================================
echo ""
echo "1Ô∏è‚É£  EJECUTANDO ESCENARIO TG-43 (AGUA PURA)"
echo "-----------------------------------------------------------"
echo "Geometr√≠a: Fantoma infinito de agua"
echo "Prop√≥sito: Establecer referencia est√°ndar"
echo "Eventos: 15,000 para estad√≠stica robusta"

# Configurar direcci√≥n is√≥tropa para TG-43
/gun/direction 1 0 0

# Ejecutar simulaci√≥n TG-43
/run/beamOn 15000

# Exportar resultados TG-43
/score/dumpQuantityToFile comparison_mesh eDep tg43_baseline_energy.txt
/score/dumpQuantityToFile comparison_mesh dose tg43_baseline_dose.txt

echo "‚úÖ Escenario TG-43 completado"
echo "üìÅ Archivos: tg43_baseline_*.txt"

# Reset scoring mesh para pr√≥ximo escenario
/score/close
/score/create/boxMesh comparison_mesh
/score/mesh/boxSize 15 15 15 cm
/score/mesh/nBin 50 50 50
/score/mesh/translate/xyz 0 0 0 cm
/score/quantity/energyDeposit eDep
/score/quantity/doseDeposit dose
/score/close

# ============================================================
# ESCENARIO 2: PHANTOM HETEROG√âNEO
# ============================================================
echo ""
echo "2Ô∏è‚É£  EJECUTANDO ESCENARIO HETEROG√âNEO"
echo "-----------------------------------------------------------"
echo "Geometr√≠a: M√∫ltiples materiales anat√≥micos"
echo "  ü¶¥ Hueso cortical (œÅ=1.85 g/cm¬≥)"
echo "  üí® Cavidades a√©reas (œÅ=0.001 g/cm¬≥)"
echo "  ü´Ä M√∫sculo esquel√©tico (œÅ=1.05 g/cm¬≥)"
echo "  üü° Tejido adiposo (œÅ=0.95 g/cm¬≥)"
echo "Eventos: 15,000 (misma estad√≠stica)"

# Simular en diferentes direcciones para cubrir heterogeneidades
echo "Direcciones m√∫ltiples para muestrear heterogeneidades..."

# Direcci√≥n 1: Hacia hueso
/gun/direction 1 0 0
/run/beamOn 5000

# Direcci√≥n 2: Hacia cavidad a√©rea  
/gun/direction 0 1 0
/run/beamOn 5000

# Direcci√≥n 3: Hacia interfaz m√∫sculo-grasa
/gun/direction 0 0 1
/run/beamOn 5000

# Exportar resultados heterog√©neos
/score/dumpQuantityToFile comparison_mesh eDep heterogeneous_energy.txt
/score/dumpQuantityToFile comparison_mesh dose heterogeneous_dose.txt

echo "‚úÖ Escenario heterog√©neo completado"
echo "üìÅ Archivos: heterogeneous_*.txt"

# Reset para escenario cl√≠nico
/score/close
/score/create/boxMesh comparison_mesh
/score/mesh/boxSize 20 20 15 cm  # Volumen p√©lvico
/score/mesh/nBin 40 40 30
/score/mesh/translate/xyz 0 0 0 cm
/score/quantity/energyDeposit eDep
/score/quantity/doseDeposit dose
/score/close

# ============================================================
# ESCENARIO 3: CL√çNICO REALISTA
# ============================================================
echo ""
echo "3Ô∏è‚É£  EJECUTANDO ESCENARIO CL√çNICO"
echo "-----------------------------------------------------------"
echo "Geometr√≠a: Anatom√≠a p√©lvica + aplicador ginecol√≥gico"
echo "  üè• Paciente realista"
echo "  üîß Aplicador ring + tandem"
echo "  üéØ M√∫ltiples posiciones de parada"
echo "Eventos: 12,000 (3,000 por posici√≥n)"

# Posici√≥n 1: Tandem superior
echo "üìç Posici√≥n 1: Tandem superior (+25mm)"
/gun/position 0 0 25 mm
/run/beamOn 3000

# Posici√≥n 2: Tandem medio
echo "üìç Posici√≥n 2: Tandem medio (0mm)"
/gun/position 0 0 0 mm
/run/beamOn 3000

# Posici√≥n 3: Ovoid izquierdo
echo "üìç Posici√≥n 3: Ovoid izquierdo (-12mm, +15mm)"
/gun/position -12 15 0 mm
/run/beamOn 3000

# Posici√≥n 4: Ovoid derecho
echo "üìç Posici√≥n 4: Ovoid derecho (+12mm, +15mm)"
/gun/position 12 15 0 mm
/run/beamOn 3000

# Exportar resultados cl√≠nicos
/score/dumpQuantityToFile comparison_mesh eDep clinical_energy.txt
/score/dumpQuantityToFile comparison_mesh dose clinical_dose.txt

echo "‚úÖ Escenario cl√≠nico completado"
echo "üìÅ Archivos: clinical_*.txt"

# ============================================================
# RESUMEN FINAL
# ============================================================
echo ""
echo "üèÅ ESTUDIO COMPARATIVO COMPLETADO"
echo "============================================================="
echo ""
echo "üìä ARCHIVOS GENERADOS PARA AN√ÅLISIS:"
echo "   1. tg43_baseline_*.txt     (Referencia est√°ndar)"
echo "   2. heterogeneous_*.txt     (Efectos de materiales)"
echo "   3. clinical_*.txt          (Escenario realista)"
echo ""
echo "üìà AN√ÅLISIS RECOMENDADO:"
echo "   ‚Ä¢ Mapas de diferencia relativa vs TG-43"
echo "   ‚Ä¢ Histogramas dosis-volumen (DVH)"
echo "   ‚Ä¢ M√©tricas de OARs (D2cc, Dmax)"
echo "   ‚Ä¢ Estad√≠stica de desviaciones"
echo ""
echo "üêç EJECUTAR AN√ÅLISIS PYTHON:"
echo "   python3 ../scripts/comparative_analysis.py"
echo ""
echo "üìã RESULTADOS ESPERADOS:"
echo "   ‚Ä¢ TG-43 vs Heterog√©neo: ¬±5-30% desviaciones"
echo "   ‚Ä¢ TG-43 vs Cl√≠nico: ¬±10-40% en OARs cr√≠ticos"
echo "   ‚Ä¢ Justificaci√≥n para Monte Carlo en HDR"
echo "============================================================="
